# Fichier .gitlab-ci.yml - Partie 4 : Intégration de Trivy
# Objectif : Ajouter un scanner de sécurité pour l'IaC (Trivy).

# Définition des stages
stages:
  - setup
  - iac_checks
  - linter_scan
  - security_scan

# --- Job 1 : Vérification de l'existence d'un répertoire (inchangé) ---
check_dir_job:
  stage: setup
  image: alpine:latest
  script:
    - echo "Vérification de l'existence du répertoire 'exemple'..."
    - test -d exemple
    - echo "Répertoire 'exemple' trouvé."

# --- Job 2 : Installation de Terraform (inchangé) ---
install_tf_job:
  stage: setup
  image: ubuntu:latest
  before_script:
    - apt-get update -y && apt-get install -y wget unzip ca-certificates
    - update-ca-certificates
  script:
    - echo "Installation de Terraform (v1.14.3)..."
    - wget https://releases.hashicorp.com/terraform/1.14.3/terraform_1.14.3_linux_amd64.zip
    - unzip terraform_1.14.3_linux_amd64.zip
    - ./terraform version
  # Rendre l'exécutable Terraform disponible pour les jobs suivants
  artifacts:
    paths:
      - ./terraform
    expire_in: 1 hour

# --- Job 3 : Installation de TFLINT (Nouveau) ---
install_tflint_job:
  stage: setup
  image: ubuntu:latest
  before_script:
    - apt-get update -y && apt-get install -y wget unzip
  script:
    - echo "Installation de TFLINT (v0.51.0)..."
    - wget https://github.com/terraform-linters/tflint/releases/download/v0.51.0/tflint_linux_amd64.zip
    - unzip tflint_linux_amd64.zip
    - ./tflint --version
  artifacts:
    paths:
      - ./tflint
    expire_in: 1 hour

# --- Job 4 : Validation de la syntaxe Terraform (inchangé) ---
tf_validate_job:
  stage: iac_checks
  image: ubuntu:latest
  needs: ["install_tf_job"]
  before_script:
    - apt-get update -y && apt-get install -y ca-certificates
    - update-ca-certificates
  script:
    - export PATH=$PATH:$(pwd)  
    - echo "Exécution de 'terraform init'..."
    - terraform init
    - echo "Exécution de 'terraform validate'..."
    - terraform validate

# --- Job 5 : Initialisation et Planification (inchangé) ---
tf_plan_job:
  stage: iac_checks
  image: ubuntu:latest
  needs: ["install_tf_job","tf_validate_job"]
  before_script:
    - apt-get update -y && apt-get install -y ca-certificates
    - update-ca-certificates
  script:
    - export PATH=$PATH:$(pwd)
    - echo "Exécution de 'terraform init'..."
    - terraform init
    - echo "Exécution de 'terraform plan'..."
    - terraform plan

# --- Job 6 : Exécution de TFLINT ---
tflint_check_job:
  stage: linter_scan
  image: ubuntu:latest
  needs: ["install_tflint_job"]
  script:
    - export PATH=$PATH:$(pwd)
    - echo "Exécution de 'tflint'..."
    - tflint --init # Initialisation des plugins
    - tflint # Exécution du linter

# --- Job 7 : Exécution de Trivy ---
trivy_scan_iac_job:
  stage: security_scan
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  needs: ["install_tf_job"]
  before_script:
    - export PATH=$PATH:$(pwd)
    - terraform init
    - terraform plan --out tfplan
  script:
    - echo "Exécution de Trivy sur le code IaC (Terraform)..."
    # L'image officielle contient déjà le binaire trivy
    - trivy config --exit-code 1 --severity MEDIUM,HIGH,CRITICAL tfplan
