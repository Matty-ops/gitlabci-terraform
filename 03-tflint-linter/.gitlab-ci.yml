# Fichier .gitlab-ci.yml - Partie 3 : Intégration de TFLINT
# Objectif : Ajouter le linter TFLINT pour vérifier la qualité du code.

# Définition des stages
stages:
  - setup
  - iac_checks
  - linter_scan

# --- Job 1 : Vérification de l'existence d'un répertoire (inchangé) ---
check_dir_job:
  stage: setup
  image: alpine:latest
  script:
    - echo "Vérification de l'existence du répertoire 'exemple'..."
    - test -d exemple
    - echo "Répertoire 'exemple' trouvé."

# --- Job 2 : Installation de Terraform (inchangé) ---
install_tf_job:
  stage: setup
  image: ubuntu:latest
  before_script:
    - apt-get update -y && apt-get install -y wget unzip
  script:
    - echo "Installation de Terraform (v1.7.5)..."
    - wget https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
    - unzip terraform_1.7.5_linux_amd64.zip
    - mv terraform /usr/local/bin/
    - terraform version
  artifacts:
    paths:
      - /usr/local/bin/terraform
    expire_in: 1 hour

# --- Job 3 : Installation de TFLINT (Nouveau) ---
install_tflint_job:
  stage: setup
  image: ubuntu:latest
  before_script:
    - apt-get update -y && apt-get install -y wget unzip
  script:
    - echo "Installation de TFLINT (v0.51.0)..."
    - wget https://github.com/terraform-linters/tflint/releases/download/v0.51.0/tflint_linux_amd64.zip
    - unzip tflint_linux_amd64.zip
    - mv tflint /usr/local/bin/
    - tflint --version
  artifacts:
    paths:
      - /usr/local/bin/tflint
    expire_in: 1 hour

# --- Job 4 : Validation de la syntaxe Terraform (inchangé) ---
tf_validate_job:
  stage: iac_checks
  image: ubuntu:latest
  needs: ["install_tf_job"]
  script:
    - echo "Exécution de 'terraform validate'..."
    - terraform validate

# --- Job 5 : Initialisation et Planification (inchangé) ---
tf_plan_job:
  stage: iac_checks
  image: ubuntu:latest
  needs: ["tf_validate_job"]
  script:
    - echo "Exécution de 'terraform init'..."
    - terraform init
    - echo "Exécution de 'terraform plan'..."
    - terraform plan

# --- Job 6 : Exécution de TFLINT ---
tflint_check_job:
  stage: linter_scan
  image: ubuntu:latest
  needs: ["install_tflint_job"]
  script:
    - echo "Exécution de 'tflint'..."
    - tflint --init # Initialisation des plugins
    - tflint # Exécution du linter
